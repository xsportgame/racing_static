<!doctype html>
<html lang="en-us">
    <head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Unity WebGL Player |  FormulaSport</title>
		<link rel="stylesheet" href="TemplateData/style.css?v=10">
		<script src="TemplateData/UnityProgress.js?v=57"></script>
	
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src="//vk.com/js/api/xd_connection.js?2"  type="text/javascript"></script>
		<script src="TemplateData/js/config.js?v=70"></script>
		<script src="TemplateData/js/sockets.js?v=63"></script>
		<script type="text/javascript" src='TemplateData/js/social_network/sns.js?v=57' defer="defer"></script>
		<script type="text/javascript" src='TemplateData/js/error_logger.js?v=57' defer="defer"></script>
			
		<style>
			#gameContainer {
				z-index:1;
				position:absolute;
			}
			#preloader {
				z-index:10;
				position:absolute;
			}
		</style>
	</head>
	<body class="template">
		<p class="header"><span>Unity WebGL Player | </span> FormulaSport</p>
		<div class="main_container">
			<div id="auth_container" style="display:none;"> 
			
				<div id="auth_block">
					<div class="turn_on_help">
						<h3>Авторизация десктоп клиента</h3>
						<ol>
							<li>Для того чтобы разрешить десктоп версии клиента использовать ваш аккаунт для авторизации, нажмите кнопку "Авторизоваться"</li>
						</ol>
						<button id="copy">Авторизоваться</button>
						<ol id="auth_finish" style="display:none">
							<li>Возвращайтесь в десктоп версию клиента</li>
						</ol>
					</div>
				</div>
			</div>
			<div id="game_container" style="display:none;">
				<div class="template-wrap clear" id="preloader" >
					<div class="news"> 
						<p>ОБНОВЛЕНО 13/04/2019! В рамках работ по обновлениию чемпионатов, которые приведут к урежению кол-ва гран-при в неделю, мы решили добавить для вас возможность устроить себе заезд в любой момент. Игра с ботами теперь доступна каждому. </p> 
						<p>По нажатию на клавишу тильды (на PC буква Ё в англ раскладке) можно посмотреть влажность трассы и другие данные (Тестовый функционал)</p> 
						<p>Цвет индикатора более наглядный: зелёный — нагрев до 95, жёлтый — от 95 до 96, оранжевый — выше 96 (появляется высокий риск взрыва двигателя);</p> 
						<p>Вероятность взрыва с 96 увеличена.</p> 
						<p>ОБНОВЛЕНО! Мы обновили баланс, теперь деградация шин начинается не после 50%, а в промежутке между 50 и 35 процентов износа. Следите за темпом перед тем как решить ехать ставить новый комплект резины!</p>

						<p>Подробности смотрите в группе!</p> 
						<p>Спасибо Вам за отзывы!</p> 
						<a class="subscribe" href="https://vk.com/formulasport" target="_blank">Подписывайтесь</a>
					</div>
					<div class="preloader_animation rotating"> </div>
					<div class="logo"> </div>
				</div>
				<div id="off_webgl" style="display:none;">
					<div class="turn_on_help">
						<h3>Ваш браузер не поддерживает WebGL</h3>
						<ol>
							<li>Включите аппаратное ускорение:
								<ol>
									<li>a) Перейдите в <strong>chrome://settings</strong></li>
									<li>б) Нажмите кнопку <strong>“Показать дополнительные настройки”</strong></li>
									<li>в) В разеле <strong>Система</strong> найдите пункт <strong>“Использовать аппаратное ускорение (при наличии)”</strong> включите кликнув на флажок (и далее Вам необходимо перезапустить Google Chrome для того чтобы изменения вступили в силу)</li>
								</ol>
							</li>
							<li>Включите WebGL:
								<ol>
									<li>a) Перейдите в <strong>chrome://flags</strong></li>
									<li>б) Включите <strong>“Доступ к разрабатываемым расширениям WebGL”</strong> </li>
									<li>в) Убедитесь в том что <strong>WebGL</strong> активирован (Вам необходимо перезапустить Google Chrome для того чтобы изменения вступили в силу)</li>
								</ol>
							</li>
							<li>Проверьте состояние WebGL:
								<ol>
									<li>a) Перейдите в <strong>chrome://gpu</strong></li>
									<li>б) Найдите элемент в <strong>WebGL</strong> списке <strong><u>Graphics Feature Status</u></strong></li>
									<li>в) Надпись <strong>Hardware accelerated</strong> должна гореть зеленым</li>
								</ol>
							</li>
						</ol>
					</div>
				</div>
				<div id="no_webgl" style="display:none;">
					<div class="turn_on_help">
						<h3>Ваш браузер не поддерживает WebGL</h3>
						<ol>
							<li>Предлагаем несколько вариантов решения вопроса:
								<ol>
									<li>1) Установить другой браузер <a href="https://www.mozilla.org/ru/firefox/new/"><strong>Firefox</strong></a></li>
									<li>2) Обновить свой браузер до последней версии</li>
									<li>3) Скачать клиент для мобильной версии <a href="#"><strong>скоро</strong></a></li>
								</ol>
							</li>
						</ol>
					</div>
				</div>
				<div id="_no_webgl" style="display:none;">
					<div class="turn_on_help">
						<h3>Ранний доступ</h3>
						 <ol>
							<li>Ранний доступ закрыт, в скором времени будет доступен для скачивания мобильный релиз игры, следите за новостями в сообществе "Формула Спорт".
							</li>
						</ol> 
					</div>
				</div>
				<div id="gameContainer" style="width: 1000px; height: 700px"></div>
				<canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" height="700px" width="1000px"></canvas>
			
			</div>
		</div>
		<script type='text/javascript'>
		  
				var gameInstance = null;
		getParameterByName = function (name, url) {
			if (!url) url = window.location.href;
			name = name.replace(/[\[\]]/g, "\\$&");
			var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex.exec(url);
			if (!results) return null;
			if (!results[2]) return '';
			return decodeURIComponent(results[2].replace(/\+/g, " "));
		}
		var data_v = 57;//getParameterByName("data_v", location.href);
		  
		  var webglEnabled = true;
		  function checkCompatibility() {
			var status = webgl_detect(false);
			var isIE = getInternetExplorerVersion() !== -1;
			if(isIE){
				webglEnabled = false;
				//saveLog(getParameterByName("viewer_id", location.href), "webg unsupported isIE", "error");
				ga('send', 'event', 'Error', 'webg unsupported isIE', getParameterByName("viewer_id", location.href));  
				document.getElementById("no_webgl").style.display = "block";
				document.getElementById("canvas").style.display = "none";
				document.getElementById("preloader").style.display = "none";
			} else {
				if (status == 1 && !isIE) {
				
				
				} else if(status == 0){
					webglEnabled = false;
					//saveLog(getParameterByName("viewer_id", location.href), "webgl disabled", "error");
					ga('send', 'event', 'Error', 'webgl disabled', getParameterByName("viewer_id", location.href));  
					document.getElementById("off_webgl").style.display = "block";
					document.getElementById("canvas").style.display = "none";
					document.getElementById("preloader").style.display = "none";
				}else if(status == -1 ){
					webglEnabled = false;
					//saveLog(getParameterByName("viewer_id", location.href), "webgl unsupported", "error");
					ga('send', 'event', 'Error', 'webgl unsupported', getParameterByName("viewer_id", location.href));  
					document.getElementById("no_webgl").style.display = "block";
					document.getElementById("canvas").style.display = "none";
					document.getElementById("preloader").style.display = "none";
				}
			}
		  }
		  function getInternetExplorerVersion()
		{
			var rv = -1;
			if (navigator.appName == 'Microsoft Internet Explorer')
			{
				var ua = navigator.userAgent;
				var re  = new RegExp("MSIE ([0-9]{1,}[\.0-9]{0,})");
				if (re.exec(ua) != null)
					rv = parseFloat( RegExp.$1 );
			}
			else if (navigator.appName == 'Netscape')
			{
				var ua = navigator.userAgent;
				var re  = new RegExp("Trident/.*rv:([0-9]{1,}[\.0-9]{0,})");
				if (re.exec(ua) != null)
					rv = parseFloat( RegExp.$1 );
			}
			return rv;
		}
		  function errorHandler(err, url, line){
			var ev = new Event("ERROR_OCCURED");
			ev.data = {err:err,url:url,line:line};
			console.log(ev.data);
			dispatchEvent(ev);
			//saveLog(getParameterByName("viewer_id", location.href), JSON.stringify(ev.data), "error");
			return true; 
		  };
		  function webgl_detect(return_context) {
			if (!!window.WebGLRenderingContext) {
				var canvas = document.createElement("canvas"),
					 names = ["webgl", "experimental-webgl", "moz-webgl", "webkit-3d"],
				   context = false;

				for(var i=0;i<4;i++) {
					try {
						context = canvas.getContext(names[i]);
						if (context && typeof context.getParameter == "function") {
							// WebGL is enabled
							if (return_context) {
								// return WebGL object if the function's argument is present
								return {name:names[i], gl:context};
							}
							// else, return just true
							return 1;
						}
					} catch(e) {}
				}
				
				// WebGL is supported, but disabled
				return 0;
			}

			// WebGL not supported
			return -1;
		}
		var loadJS = function(url, implementationCode, location){
			var scriptTag = document.createElement('script');
			scriptTag.src = url;
        
			scriptTag.onload = implementationCode;
			scriptTag.onreadystatechange = implementationCode;
        
			location.appendChild(scriptTag);
		};
		  
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-91946927-1', 'auto');
		ga('send', 'pageview');
		ga('send', 'event', 'Log', 'User game load start', getParameterByName("viewer_id", location.href));  
		
		window.onerror = function(err) {
			ga('send', 'exception', {
				'exDescription': err,
				'exFatal': false
			});

			ga('send', 'event', 'Error', err,  getParameterByName("viewer_id", location.href), {
				nonInteraction: true
			});
		}

		var jsonObject
		
		if (getParameterByName("hash", location.href) == 'auth') {
			document.getElementById("auth_container").style.display = "block";
			var obj = {"uuid":getParameterByName("viewer_id", location.href), "auth_key":getParameterByName("auth_key", location.href)}
			jsonObject = JSON.stringify(obj);
			document.querySelector("#copy").onclick = function() {
				var result = copyToClipboard(jsonObject);
				document.querySelector("#copy").style.display = "none"
				document.querySelector("#auth_finish").style.display = "block"
				console.log("copied?", result);
			};
			
			//setShop(JSON.parse('[{"ID":"1","cost":4,"rating":3,"fuel":0,"color":[],"discount":0,"title":"3 рейтинга","img":""},{"ID":"2","cost":9,"rating":10,"fuel":0,"color":[],"discount":0,"title":"10 рейтинга","img":""},{"ID":"3","cost":50,"rating":60,"fuel":0,"color":[],"discount":0,"title":"60 рейтинга","img":""},{"ID":"4","cost":99,"rating":125,"fuel":0,"color":[],"discount":0,"title":"125 рейтинга","img":""},{"ID":"5","cost":3,"rating":0,"fuel":20,"color":[],"discount":0,"title":"20 кг топлива","img":""},{"ID":"6","cost":2,"rating":0,"fuel":80,"color":[],"discount":0,"title":"80 кг топлива","img":""},{"ID":"7","cost":5,"rating":0,"fuel":0,"color":["F7381C"],"discount":0,"title":"Цвет болида","img":""},{"ID":"8","cost":5,"rating":0,"fuel":0,"color":["F7E81C"],"discount":0,"title":"Цвет болида","img":""},{"ID":"9","cost":5,"rating":0,"fuel":0,"color":["2E9341"],"discount":0,"title":"Цвет болида","img":""},{"ID":"10","cost":5,"rating":0,"fuel":0,"color":["3D64E9"],"discount":0,"title":"Цвет болида","img":""},{"ID":"11","cost":5,"rating":0,"fuel":0,"color":["F7C969"],"discount":0,"title":"Цвет болида","img":""},{"ID":"12","cost":5,"rating":0,"fuel":0,"color":["989797"],"discount":0,"title":"Цвет болида","img":""},{"ID":"13","cost":5,"rating":0,"fuel":0,"color":["2C2C2C"],"discount":0,"title":"Цвет болида","img":""},{"ID":"14","cost":5,"rating":0,"fuel":0,"color":["F06767"],"discount":0,"title":"Цвет болида","img":""},{"ID":"15","cost":5,"rating":0,"fuel":0,"color":["FFFFFF"],"discount":0,"title":"Цвет болида","img":""},{"ID":"16","cost":10,"rating":0,"fuel":0,"color":["355BF3","898989"],"discount":0,"title":"Цвет болида","img":""},{"ID":"17","cost":10,"rating":0,"fuel":0,"color":["3EAD28","D6ED2D"],"discount":0,"title":"Цвет болида","img":""},{"ID":"18","cost":10,"rating":0,"fuel":0,"color":["F43636","000000"],"discount":0,"title":"Цвет болида","img":""},{"ID":"19","cost":10,"rating":0,"fuel":0,"color":["5DB581","000000"],"discount":0,"title":"Цвет болида","img":""},{"ID":"20","cost":10,"rating":0,"fuel":0,"color":["FFFFFF","29B74A"],"discount":0,"title":"Цвет болида","img":""},{"ID":"21","cost":10,"rating":0,"fuel":0,"color":["0573ED","FFFFFF"],"discount":0,"title":"Цвет болида","img":""},{"ID":"22","cost":10,"rating":0,"fuel":0,"color":["B1AFAF","000000"],"discount":0,"title":"Цвет болида","img":""},{"ID":"23","cost":10,"rating":0,"fuel":0,"color":["F54242","FFFFFF"],"discount":0,"title":"Цвет болида","img":""},{"ID":"24","cost":10,"rating":0,"fuel":0,"color":["FFFFFF","000000"],"discount":0,"title":"Цвет болида","img":""}]'));
			/*$.get("https://fsport.roolmi.com/shop", function (data) {
				setShop(data);
			});*/
			//VK.callMethod("setLocation", '');
		} else{
			document.getElementById("game_container").style.display = "block";
			var techWorks = false && (getParameterByName("viewer_id", location.href) != "9638009") && (getParameterByName("viewer_id", location.href) != "157368762")
			if (techWorks) {
				document.getElementById("preloader").style.display = "none";
				document.getElementById("no_webgl").style.display = "block";
			} else {
				document.getElementById("no_webgl").style.display = "none";
				document.getElementById("preloader").style.display = "block";
				loadJS("Build/UnityLoader.js?data_v=" + data_v, function(){
					gameInstance = UnityLoader.instantiate("gameContainer", "Build/WebGL_v1.26.json", {onProgress: UnityProgress});
				}, document.body)
			
			}
			var DEBUG = false;
			if(!DEBUG){
				if(!window.console) window.console = {};
				var methods = ["log", "debug", "info"];
				for(var i=0;i<methods.length;i++){
					console[methods[i]] = function(){
						

					};
				}
			}
			var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
			if (!isSafari && devicePixelRatio != 1) {
				devicePixelRatio = 1;
			}
			var c = document.getElementById("canvas");
			var w = c.width;
			var h = c.height;
			c.width = w * devicePixelRatio; // devicePixelRatio = 2.0 on a retina screen
			c.height = h * devicePixelRatio;
			c.style.width =(w * devicePixelRatio) + "px";
			c.style.height = (h * devicePixelRatio)+ "px";
			
			var scaleDownByPixelRatio = function() {
				if(devicePixelRatio > 1) {
					var canvas = document.getElementById("canvas");
					canvas.style.transformOrigin = "0 0";
					canvas.style.transform = "scale("+1.0/devicePixelRatio+")";
				}
			}
			scaleDownByPixelRatio();
		}
		
		
		function copyToClipboard(text) {
			if (window.clipboardData && window.clipboardData.setData) {
				// IE specific code path to prevent textarea being shown while dialog is visible.
				return clipboardData.setData("Text", text); 

			} else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
				var textarea = document.createElement("textarea");
				textarea.textContent = text;
				textarea.style.position = "fixed";  // Prevent scrolling to bottom of page in MS Edge.
				document.body.appendChild(textarea);
				textarea.select();
				try {
					return document.execCommand("copy");  // Security exception may be thrown by some browsers.
				} catch (ex) {
					console.warn("Copy to clipboard failed.", ex);
					return false;
				} finally {
					document.body.removeChild(textarea);
				}
			}
		}
		</script>

		<div style='display:none'>
			<canvas id="ImgUpload"></canvas>
			<img id="ItemPreview" crossOrigin="Anonymous" src='' />
		</div>
		<script>
			
			function getDevicePixelRatio() {
				var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
				if (!isSafari && devicePixelRatio != 1) {
					devicePixelRatio = 1;
				}
				SendMessage("Canvas", "SetScaleForDevice", devicePixelRatio)
			}
		</script>
	</body>
</html>
